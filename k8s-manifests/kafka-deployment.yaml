apiVersion: apps/v1
kind: Deployment
metadata:
  annotations:
    kompose.cmd: c:\programdata\chocolatey\lib\kubernetes-kompose\tools\kompose.exe convert -o k8s-manifests
    kompose.version: 1.37.0 (fb0539e64)
  labels:
    io.kompose.service: kafka
  name: kafka
spec:
  replicas: 1
  selector:
    matchLabels:
      io.kompose.service: kafka
  template:
    metadata:
      annotations:
        kompose.cmd: c:\programdata\chocolatey\lib\kubernetes-kompose\tools\kompose.exe convert -o k8s-manifests
        kompose.version: 1.37.0 (fb0539e64)
      labels:
        io.kompose.service: kafka
    spec:
      enableServiceLinks: false
      containers:
            - name: kafka
              image: confluentinc/cp-kafka:7.5.0

          # üü¢ ASTUCE : On nettoie le dossier de donn√©es au d√©marrage pour √©viter le conflit d'ID
          # Ceci simule le comportement "propre" de Docker Compose sans volumes
              command: [ "/bin/sh", "-c" ]
              args:
                - |
                  echo 'Nettoyage des anciennes donn√©es Kafka...'
                  rm -rf /var/lib/kafka/data/lost+found
                  rm -rf /var/lib/kafka/data/meta.properties
                  echo 'D√©marrage de Kafka...'
                  /etc/confluent/docker/run

              env:
                # Vos variables existantes (correctes)
                - name: KAFKA_HEAP_OPTS
                  value: "-Xmx512M -Xms512M"
                - name: KAFKA_ADVERTISED_LISTENERS
                  value: PLAINTEXT://kafka:9092
                - name: KAFKA_LISTENERS
                  value: PLAINTEXT://0.0.0.0:9092
                - name: KAFKA_BROKER_ID
                  value: "1"
                - name: KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR
                  value: "1"
                - name: KAFKA_ZOOKEEPER_CONNECT
                  value: zookeeper:2181

              ports:
                - containerPort: 9092
                  protocol: TCP

          # Augmentation du d√©lai pour Zookeeper
              readinessProbe:
                tcpSocket:
                  port: 9092
                initialDelaySeconds: 20
                periodSeconds: 10
                failureThreshold: 5
                successThreshold: 1
                timeoutSeconds: 5

      restartPolicy: Always
